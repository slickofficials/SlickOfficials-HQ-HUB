<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>SlickOfficials HQ â€” Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <script>
    async function fetchStatus() {
        try {
            const res = await fetch('/status');
            const json = await res.json();
            const eta = json.next_post_eta_seconds || 0;
            startCountdown(eta);
            document.getElementById('summary').innerText = JSON.stringify(json, null, 2);
        } catch (e) {
            console.error(e);
        }
    }

    function startCountdown(seconds) {
        const el = document.getElementById('countdown');
        const bar = document.getElementById('progress-bar');
        const total = seconds || 1;
        let remaining = Math.max(0, Math.floor(total));
        function tick() {
            if (remaining <= 0) {
                el.innerText = "Posting now or soon...";
                bar.style.width = "100%";
                return;
            }
            const h = Math.floor(remaining/3600);
            const m = Math.floor((remaining%3600)/60);
            const s = remaining % 60;
            el.innerText = `${h}h ${m}m ${s}s`;
            const pct = Math.floor((1 - (remaining/total)) * 100);
            bar.style.width = pct + "%";
            remaining--;
            setTimeout(tick, 1000);
        }
        tick();
    }

    window.onload = function() {
        fetchStatus();
    }
    </script>
</head>
<body>
    <header>
        <h1>ðŸ”¥ SlickOfficials HQ</h1>
        <p>Auto-post every {{ config.POST_INTERVAL_HOURS if config.POST_INTERVAL_HOURS else 4 }} hours â€¢ AWIN: {{config.AWIN_PUBLISHER_ID}} â€¢ Rakuten: {{config.RAKUTEN_SCOPE_ID}}</p>
    </header>

    <section>
        <h2>Next Auto Post</h2>
        <div id="countdown">Loading...</div>
        <div id="progress-bar-container"><div id="progress-bar"></div></div>
    </section>

    <section>
        <h2>Recent Posts (Top 50)</h2>
        {% if posts %}
        <ul>
            {% for p in posts %}
            <li>
                <strong>{{ p.post_text }}</strong><br>
                <small>Platforms: {{ p.platform }}</small><br>
                <a href="{{ p.link }}" target="_blank">{{ p.link }}</a><br>
                {% if p.image_url %}
                <img src="{{ p.image_url }}" width="200" alt="img">
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p>No posts yet. Wait for approval polls or use manual endpoints.</p>
        {% endif %}
    </section>

    <section>
        <h2>System Summary (JSON)</h2>
        <pre id="summary">Loading...</pre>
    </section>

    <section>
        <h2>Quick Actions</h2>
        <p>Trigger manual actions (use Render web console or curl):</p>
        <pre>
POST /manual_discover?token=YOUR_TOKEN
POST /manual_trigger_posts?token=YOUR_TOKEN
        </pre>
    </section>
</body>
</html>
